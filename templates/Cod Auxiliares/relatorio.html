<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Relat√≥rio de Contatos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-dark text-light">
  <div class="container py-4">
    <h2 class="mb-4">üìä Dashboard Relat√≥rio de Contatos TESTE</h2>

    <div class="mb-4">
      <a href="{{ url_for('index') }}" class="btn btn-outline-light">‚¨Ö Voltar para o In√≠cio</a>
    </div>

    <!-- Filtros -->
    <form method="get" action="/dashboard-relatorio" class="row g-3 mb-4" autocomplete="off">
  <div class="col-12 col-md-6">
    <label for="data_inicio" class="form-label">Data In√≠cio</label>
    <input type="date" name="data_inicio" id="data_inicio" class="form-control" value="{{ data_inicio or '' }}">
  </div>
  <div class="col-12 col-md-6">
    <label for="data_fim" class="form-label">Data Fim</label>
    <input type="date" name="data_fim" id="data_fim" class="form-control" value="{{ data_fim or '' }}">
  </div>

  <div class="col-12 col-md-6">
    <label for="consultor" class="form-label">Consultor</label>
    <input type="text" name="consultor" id="consultor" class="form-control" placeholder="Nome do consultor" value="{{ consultor or '' }}">
  </div>

  <div class="col-12 col-md-6 d-flex align-items-end gap-2">
    <button type="submit" class="btn btn-primary w-100">üîé Filtrar</button>
    <a href="/dashboard-relatorio" class="btn btn-outline-light w-100">‚ùå Limpar</a>
  </div>

  <!-- Filtros ocultos usados pelos gr√°ficos -->
  <input type="hidden" name="status_aluno" id="filtro_status" value="{{ status_aluno or '' }}">
  <input type="hidden" name="consultor_click" id="filtro_consultor" value="{{ consultor_click or '' }}">
</form>


      <!-- Filtros ocultos (clique no gr√°fico) -->
      <input type="hidden" name="status_aluno" id="filtro_status" value="{{ status_aluno or '' }}">
      <input type="hidden" name="consultor_click" id="filtro_consultor" value="{{ consultor_click or '' }}">
    </form>

    <!-- Gr√°ficos -->
    <div class="row mb-5">
      <div class="col-md-6">
        <canvas id="graficoStatus" height="300"></canvas>
      </div>
      <div class="col-md-6">
        <canvas id="graficoConsultor" height="300"></canvas>
      </div>
    </div>

    <!-- Tabela -->
    <div class="table-responsive">
      <table class="table table-bordered table-dark table-hover">
        <thead>
          <tr>
            <th>Nome</th>
            <th>Telefone</th>
            <th>Email</th>
            <th>Base</th>
            <th>Base Disponibilizada</th>
            <th>Consultor</th>
            <th>Status Aluno</th>
            <th>Primeiro Contato</th>
            <th>Segundo Contato</th>
            <th>Finalizado</th>
          </tr>
        </thead>
        <tbody>
          {% for row in dados %}
          <tr>
            <td>{{ row.Nome }}</td>
            <td>{{ row.Telefone }}</td>
            <td>{{ row.Email }}</td>
            <td>{{ row.Base }}</td>
            <td>{{ row.Base_disponibilizada }}</td>
            <td>{{ row.Consultor }}</td>
            <td>{{ row.Status_aluno }}</td>
            <td>{{ row.Primeiro_contato }}</td>
            <td>{{ row.Segundo_contato }}</td>
            <td>{{ row.Finalizado }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagina√ß√£o -->
    <nav aria-label="Navega√ß√£o de p√°gina" class="mt-4">
      <ul class="pagination justify-content-center">
        {% if page > 1 %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('dashboard_relatorio', page=page-1, data_inicio=data_inicio, data_fim=data_fim, consultor=consultor, status_aluno=status_aluno, consultor_click=consultor_click) }}">¬´ Anterior</a>
        </li>
        {% endif %}

        {% if page > 2 %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('dashboard_relatorio', page=1, data_inicio=data_inicio, data_fim=data_fim, consultor=consultor, status_aluno=status_aluno, consultor_click=consultor_click) }}">1</a>
        </li>
        {% if page > 3 %}
        <li class="page-item disabled"><span class="page-link">...</span></li>
        {% endif %}
        {% endif %}

        {% for p in range(page-2, page+3) %}
        {% if p > 0 and p <= total_paginas %}
        <li class="page-item {% if p == page %}active{% endif %}">
          <a class="page-link" href="{{ url_for('dashboard_relatorio', page=p, data_inicio=data_inicio, data_fim=data_fim, consultor=consultor, status_aluno=status_aluno, consultor_click=consultor_click) }}">{{ p }}</a>
        </li>
        {% endif %}
        {% endfor %}

        {% if page < total_paginas - 2 %}
        {% if page < total_paginas - 3 %}
        <li class="page-item disabled"><span class="page-link">...</span></li>
        {% endif %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('dashboard_relatorio', page=total_paginas, data_inicio=data_inicio, data_fim=data_fim, consultor=consultor, status_aluno=status_aluno, consultor_click=consultor_click) }}">{{ total_paginas }}</a>
        </li>
        {% endif %}

        {% if page < total_paginas %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('dashboard_relatorio', page=page+1, data_inicio=data_inicio, data_fim=data_fim, consultor=consultor, status_aluno=status_aluno, consultor_click=consultor_click) }}">Pr√≥xima ¬ª</a>
        </li>
        {% endif %}
      </ul>
    </nav>
  </div>

  <!-- Scripts -->
  <script>
    const statusData = {{ grafico_status|tojson }};
    const consultorData = {{ grafico_consultor|tojson }};

    const chartStatus = new Chart(document.getElementById('graficoStatus'), {
      type: 'bar',
      data: {
        labels: Object.keys(statusData),
        datasets: [{
          label: 'Total por Status',
          data: Object.values(statusData),
          backgroundColor: 'rgba(0, 123, 255, 0.7)'
        }]
      },
      options: {
        plugins: { legend: { display: false } },
        responsive: true,
        scales: { y: { beginAtZero: true } }
      }
    });

    const chartConsultor = new Chart(document.getElementById('graficoConsultor'), {
      type: 'bar',
      data: {
        labels: Object.keys(consultorData),
        datasets: [{
          label: 'Total por Consultor',
          data: Object.values(consultorData),
          backgroundColor: 'rgba(40, 167, 69, 0.7)'
        }]
      },
      options: {
        plugins: { legend: { display: false } },
        responsive: true,
        scales: { y: { beginAtZero: true } }
      }
    });

    // Clique nos gr√°ficos para aplicar filtros autom√°ticos
    document.getElementById('graficoStatus').onclick = function (evt) {
      const activePoint = chartStatus.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
      if (activePoint.length) {
        const label = chartStatus.data.labels[activePoint[0].index];
        document.getElementById('filtro_status').value = label;
        document.querySelector('form').submit();
      }
    };

    document.getElementById('graficoConsultor').onclick = function (evt) {
      const activePoint = chartConsultor.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
      if (activePoint.length) {
        const label = chartConsultor.data.labels[activePoint[0].index];
        document.getElementById('filtro_consultor').value = label;
        document.querySelector('form').submit();
      }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
