
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <title>Dashboard Interativo Completo</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background-color: #0d0d1a;
      color: #ffffff;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
    }
    select, input[type="text"], input[type="date"] {
      padding: 8px;
      border-radius: 5px;
      background-color: #1a1a2e;
      color: #fff;
      border: none;
      margin-right: 10px;
    }
    .container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-gap: 20px;
    }
    .card {
      background-color: #1a1a2e;
      padding: 15px;
      border-radius: 10px;
    }
    .card h3 {
      margin-bottom: 10px;
      color: #00e0ff;
    }
    canvas {
      background-color: #12122b;
      border-radius: 10px;
      padding: 10px;
    }
    .indicadores {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 30px;
    }
    .card-indicador {
      background-color: #1a1a2e;
      padding: 15px 25px;
      border-radius: 10px;
      min-width: 150px;
      flex: 1;
    }
    .card-indicador h4 {
      margin: 0 0 10px;
      color: #00e0ff;
      font-size: 16px;
    }
    .card-indicador p {
      font-size: 20px;
      font-weight: bold;
    }
    .btn {
      text-decoration: none;
      background-color: #00bfa6;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      border: none;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #1a1a2e;
      margin-top: 20px;
    }
    th, td {
      padding: 10px;
      border: 1px solid #333;
      text-align: left;
    }
    th {
      background-color: #12122b;
      color: #00e0ff;
    }
    tr:hover {
      background-color: #292947;
    }
  </style>
</head>
<body>

<h2>Dashboard com Gráficos + Tabela Detalhada</h2>

<!-- Indicadores -->
<div class="indicadores">
  <div class="card-indicador"><h4>Total Telefones</h4><p id="ind-total-telefones"></p></div>
  <div class="card-indicador"><h4>Total Contatados</h4><p id="ind-total-contatados"></p></div>
  <div class="card-indicador"><h4>Total Não Contatados</h4><p id="ind-nao-contatados"></p></div>
  <div class="card-indicador"><h4>Finalizados</h4><p id="ind-finalizados"></p></div>
  <div class="card-indicador"><h4>Em Negociação</h4><p id="ind-negociacao"></p></div>
  <div class="card-indicador"><h4>Matriculados</h4><p id="ind-matriculados"></p></div>
  <div class="card-indicador"><h4>Contatados Hoje</h4><p id="ind-hoje"></p></div>
  <div class="card-indicador"><h4>Já é Aluno</h4><p id="ind-ja-aluno"></p></div>
</div>

<!-- Filtros Globais -->
<div style="margin-bottom: 20px;">
  <label>Consultor:</label>
  <select id="filtroConsultor"><option value="">Todos</option></select>

  <label>Status:</label>
  <select id="filtroStatus">
    <option value="">Todos</option>
    <option value="Finalizado">Finalizado</option>
    <option value="Em Negociação">Em Negociação</option>
    <option value="Matriculado">Matriculado</option>
    <option value="Já é Aluno">Já é Aluno</option>
  </select>

  <label>Mês:</label>
  <select id="filtroMes">
    <option value="">Todos</option>
    <script>
      for (let i = 1; i <= 12; i++) {
        const val = i.toString().padStart(2, '0');
        document.write(`<option value="${val}">${val}</option>`);
      }
    </script>
  </select>

  <label>Data:</label>
  <input type="date" id="filtroData">
</div>

<!-- Gráficos -->
<div class="container">
  <div class="card">
    <h3>Negociações por Mês</h3>
    <canvas id="graficoNegociacoesMes"></canvas>
  </div>
  <div class="card">
    <h3>Matriculados por Dia da Semana</h3>
    <canvas id="graficoMatriculadosMes"></canvas>
  </div>
  <div class="card" style="grid-column: span 2;">
    <h3>Status dos Alunos</h3>
    <canvas id="graficoStatusAluno"></canvas>
  </div>
</div>

<!-- Filtros da tabela -->
<div class="filtro">
  <input type="text" id="filtroNome" placeholder="Filtrar por Nome">
  <input type="text" id="filtroTelefone" placeholder="Filtrar por Telefone">
  <input type="text" id="filtroEmail" placeholder="Filtrar por Email">
  <input type="text" id="filtroBase" placeholder="Filtrar por Base">
  <input type="text" id="filtroBaseDisp" placeholder="Filtrar por Base Disponibilizada">
</div>

<table id="tabelaContatos">
  <thead>
    <tr>
      <th>Nome</th>
      <th>Telefone</th>
      <th>Email</th>
      <th>Base</th>
      <th>Base Disponibilizada</th>
      <th>Consultor</th>
      <th>Status</th>
      <th>Primeiro Contato</th>
      <th>Segundo Contato</th>
      <th>Finalizado</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div style="margin-top: 20px; display: flex; gap: 10px; align-items: center;">
  <button onclick="paginaAnterior()" class="btn">◀ Anterior</button>
  <span id="paginacaoInfo">Página 1</span>
  <button onclick="proximaPagina()" class="btn">Próxima ▶</button>
</div>

<script>
  const todosDados = {{ todosDados|tojson }};
  const todosDadosTabela = todosDados.totais?.contatos || [];
  let paginaAtual = 1;
  const porPagina = 50;
  let dadosFiltrados = [];

  const chartNegociacoes = new Chart(document.getElementById('graficoNegociacoesMes'), {
    type: 'bar',
    data: { labels: [], datasets: [{ label: 'Negociações', data: [], backgroundColor: '#00e0ff' }] }
  });
  const chartMatriculados = new Chart(document.getElementById('graficoMatriculadosMes'), {
    type: 'bar',
    data: { labels: [], datasets: [{ label: 'Matriculados', data: [], backgroundColor: '#00bfa6' }] }
  });
  const chartStatusAluno = new Chart(document.getElementById('graficoStatusAluno'), {
    type: 'bar',
    data: { labels: [], datasets: [{ label: 'Status', data: [], backgroundColor: '#ff6384' }] }
  });

  function atualizarIndicadores(ind) {
    document.getElementById("ind-total-telefones").innerText = ind["Total Telefones"] || 0;
    document.getElementById("ind-total-contatados").innerText = ind["Total Contatados"] || 0;
    document.getElementById("ind-nao-contatados").innerText = ind["Total Não Contatados"] || 0;
    document.getElementById("ind-finalizados").innerText = ind["Finalizados"] || 0;
    document.getElementById("ind-negociacao").innerText = ind["Em Negociação"] || 0;
    document.getElementById("ind-matriculados").innerText = ind["Matriculados"] || 0;
    document.getElementById("ind-ja-aluno").innerText = ind["Já é Aluno"] || 0;
    document.getElementById("ind-hoje").innerText = ind["Contatados Hoje"] || 0;
  }

  function atualizarGraficosComTabela() {
    const indicadores = {
      "Total Telefones": dadosFiltrados.length,
      "Total Contatados": dadosFiltrados.filter(c => c.Primeiro_contato).length,
      "Total Não Contatados": dadosFiltrados.filter(c => !c.Primeiro_contato).length,
      "Finalizados": dadosFiltrados.filter(c => c.Status_aluno === "Finalizado").length,
      "Em Negociação": dadosFiltrados.filter(c => c.Status_aluno === "Em Negociação").length,
      "Matriculados": dadosFiltrados.filter(c => c.Status_aluno === "Matriculado").length,
      "Já é Aluno": dadosFiltrados.filter(c => c.Status_aluno === "Já é Aluno").length,
      "Contatados Hoje": dadosFiltrados.filter(c => {
        if (!c.Primeiro_contato) return false;
        const hoje = new Date().toLocaleDateString("pt-BR");
        return c.Primeiro_contato.startsWith(hoje);
      }).length
    };

    const negociacoes = {}, matriculados = {}, status_aluno = {};
    dadosFiltrados.forEach(c => {
      const mes = c.Primeiro_contato?.split("/").slice(1).reverse().join("/") || "Sem Data";
      if (c.Status_aluno === "Em Negociação") negociacoes[mes] = (negociacoes[mes] || 0) + 1;
      if (c.Status_aluno === "Matriculado") matriculados[mes] = (matriculados[mes] || 0) + 1;
      if (c.Status_aluno) status_aluno[c.Status_aluno] = (status_aluno[c.Status_aluno] || 0) + 1;
    });

    atualizarIndicadores(indicadores);
    chartNegociacoes.data.labels = Object.keys(negociacoes);
    chartNegociacoes.data.datasets[0].data = Object.values(negociacoes);
    chartNegociacoes.update();

    chartMatriculados.data.labels = Object.keys(matriculados);
    chartMatriculados.data.datasets[0].data = Object.values(matriculados);
    chartMatriculados.update();

    chartStatusAluno.data.labels = Object.keys(status_aluno);
    chartStatusAluno.data.datasets[0].data = Object.values(status_aluno);
    chartStatusAluno.update();
  }

  function aplicarFiltrosTabela() {
    const nome = document.getElementById('filtroNome').value.toLowerCase();
    const telefone = document.getElementById('filtroTelefone').value.toLowerCase();
    const email = document.getElementById('filtroEmail').value.toLowerCase();
    const base = document.getElementById('filtroBase').value.toLowerCase();
    const baseDisp = document.getElementById('filtroBaseDisp').value.toLowerCase();
    const consultor = document.getElementById('filtroConsultor')?.value;
    const status = document.getElementById('filtroStatus')?.value.toLowerCase();
    const mes = document.getElementById('filtroMes')?.value;
    const data = document.getElementById('filtroData')?.value;

    dadosFiltrados = todosDadosTabela.filter(dado => {
      const condTexto =
        dado.Nome.toLowerCase().includes(nome) &&
        dado.Telefone.toLowerCase().includes(telefone) &&
        dado.Email.toLowerCase().includes(email) &&
        dado.Base.toLowerCase().includes(base) &&
        dado.Base_disponibilizada.toLowerCase().includes(baseDisp);

      const condConsultor = !consultor || dado.Consultor === consultor;
      const condStatus = !status || dado.Status_aluno?.toLowerCase() === status;
      const condMes = !mes || (dado.Primeiro_contato && dado.Primeiro_contato.split("/")[1] === mes);
      const condData = !data || (dado.Primeiro_contato && dado.Primeiro_contato.startsWith(data.split("-").reverse().join("/")));

      return condTexto && condConsultor && condStatus && condMes && condData;
    });

    paginaAtual = 1;
    renderizarTabela();
  }

  function renderizarTabela() {
    const corpoTabela = document.querySelector('#tabelaContatos tbody');
    corpoTabela.innerHTML = '';

    const inicio = (paginaAtual - 1) * porPagina;
    const fim = inicio + porPagina;
    const paginaDados = dadosFiltrados.slice(inicio, fim);

    paginaDados.forEach(dado => {
      const linha = `
        <tr>
          <td>${dado.Nome}</td>
          <td>${dado.Telefone}</td>
          <td>${dado.Email}</td>
          <td>${dado.Base}</td>
          <td>${dado.Base_disponibilizada}</td>
          <td>${dado.Consultor}</td>
          <td>${dado.Status_aluno}</td>
          <td>${dado.Primeiro_contato}</td>
          <td>${dado.Segundo_contato}</td>
          <td>${dado.Finalizado}</td>
        </tr>`;
      corpoTabela.insertAdjacentHTML('beforeend', linha);
    });

    document.getElementById('paginacaoInfo').innerText =
      `Página ${paginaAtual} de ${Math.ceil(dadosFiltrados.length / porPagina)}`;

    atualizarGraficosComTabela();
  }

  function proximaPagina() {
    if (paginaAtual * porPagina < dadosFiltrados.length) {
      paginaAtual++;
      renderizarTabela();
    }
  }

  function paginaAnterior() {
    if (paginaAtual > 1) {
      paginaAtual--;
      renderizarTabela();
    }
  }

  document.querySelectorAll('input, select').forEach(el => {
    el.addEventListener('input', aplicarFiltrosTabela);
    el.addEventListener('change', aplicarFiltrosTabela);
  });

  dadosFiltrados = todosDadosTabela;
  renderizarTabela();
</script>

</body>
</html>
